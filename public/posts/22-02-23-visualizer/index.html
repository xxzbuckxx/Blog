<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>3D visualization - Boids | Zack Traczyk</title><meta name=keywords content="Javascript,DSI,3d modeling,complexity theory"><meta name=description content="Simulating flocking behavior in the browser."><meta name=author content="Zack Traczyk"><link rel=canonical href=https://canonical.url/to/page><link crossorigin=anonymous href=/assets/css/stylesheet.d59b00fcdb14783a46cbfbb94e103fe93b3da0b79ca0d96d784ec9bc2e34529d.css integrity="sha256-1ZsA/NsUeDpGy/u5ThA/6Ts9oLecoNlteE7JvC40Up0=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://example.org/personal-logo.svg><link rel=icon type=image/png sizes=16x16 href=http://example.org/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://example.org/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://example.org/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://example.org/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="3D visualization - Boids"><meta property="og:description" content="Simulating flocking behavior in the browser."><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/posts/22-02-23-visualizer/"><meta property="og:image" content="http://example.org/22-02-25__ThreeJS-Boids%20Working-StrawMesh.gif"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-15T11:30:03+00:00"><meta property="article:modified_time" content="2020-09-15T11:30:03+00:00"><meta property="og:site_name" content="ExampleSite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://example.org/22-02-25__ThreeJS-Boids%20Working-StrawMesh.gif"><meta name=twitter:title content="3D visualization - Boids"><meta name=twitter:description content="Simulating flocking behavior in the browser."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://example.org/posts/"},{"@type":"ListItem","position":2,"name":"3D visualization - Boids","item":"http://example.org/posts/22-02-23-visualizer/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"3D visualization - Boids","name":"3D visualization - Boids","description":"Simulating flocking behavior in the browser.","keywords":["Javascript","DSI","3d modeling","complexity theory"],"articleBody":"Mission Using the 3D visualization tools in the DSI I plan to make an interactive visualization. Specifically I plan to replicate flocking behavior using Boids, an emerging phenomena and example of complexity theory.\nI hope to use the Looking Glass Portrait, and the Looking Glass 4K to display my simulation in holographic 3D space. Additionally, I plan to use Ultraleap to interact with the by tracking a hand in open air.\nHere is my non-holographic demo.\nEquipment Looking Glass\nProject Log I documented my progress on this project below. Although this is not meant to be a guide, it can be used as one given some experience in JavaScript and the code provided at the beginning of each update.\n22-02-23 Software Compatibility \u0026 ThreeJS Setup Here is the code at the end of this stage\nFirst Thing I looked into is the software that allows the looking glass/portrait to visualize things real time. Luckily, HoloPlay (the software that the portrait uses) has a plugin for ThreeJS, a javascript framework I have a bit of experience in.\nHoloPlayer ThreeJS Plugin Tutorial\nFortunately, I had already made a 2D vision of a Boid simulation using JavaScript inspired by Flocks, Herds, and Schools: A Distributed Behavioral Model. It would take some work as I needed to change rendering engines for HTML5’s Canvas to ThreeJS, but the logic of the simulation was already figured out which would greatly reduce the difficulty in making the simulation.\nAfter restructuring the project and adding a import-map to use JavaScript Modules, I made a simple rotating cube animation.\n22-02-25 Debug Setup and Naive Boid Movement Here is the code at the end of this stage\nNow that the camera and renderer were setup, I began working on animating a single Boid. I used my constructed box as a bounding box to contain the Boids (eventually this bounding box will be the Looking Glass). I used my previous 2D Boid Code as a template for the methods and operations I needed, and I kept the same Boid/BoidController structure with my BoidController class needing minor adjustments.\nInitializing a Boid The first thing I did was create a Boid mesh. The geometry of a Boid can be anything; in more practical examples the mesh would be a bird, or a fish. However to simplify debugging I made the mesh a Tetrahedron with the built-in normal material:\nconst geometry = new THREE.ConeGeometry(0.05, 0.2, 3); const material = new THREE.MeshNormalMaterial(); Along with the shape, the main Differences in Boid proprieties were representing the position and velocity as a THREE.vector3 instead of as individual vector components.\nSince I was now using vectors, most of my code could be easily simplified as ThreeJS has all of the needed vector operations built into their THREE.Vector3 class. This left the refactored code looking much cleaner but also took some time and research into using ThreeJS properly.\nHere is how the Boid is initialized now:\nconstructor(x, y, z) { // Create Mesh this.mesh = new THREE.Mesh(geometry, material); this.mesh.position.set(x, y, z); // Randomize velocity this.vel = new THREE.Vector3().randomDirection(); this.maxSpeed = 0.02 } Moving a Boid Now that Boids can be created, I need them to move and do things. First I made a simple function to randomly place the Boid somewhere in the bounding box. Next I focused on the basic operations in the update loop: moving a Boid according to its velocity, and pointing a Boid in the direction of its velocity.\nThese operations only required basic vector operations already implemented in ThreeJS:\n// Update positions this.mesh.position.add(this.vel); // Update direction const axis = new THREE.Vector3(0, 1, 0); this.mesh.quaternion.setFromUnitVectors(axis, this.vel.clone().normalize()); Now that a Boid can move, it needs to stay below a maximum speed, and stay within a bounding box. To handle speed I again used simple ThreeJS methods to clamp the speed of a Boid. Then to keep inside the bounding Box, I implemented a function pushOnScreen(boundary) that checks if the position of a Boid exceeds the box boundary subtracted by a margin. I adjust each component of the velocity vector by a turning factor to steer away from the wall and back towards the center.\nconst boundingBox = new THREE.Box3().setFromObject(boundary); const origin = boundingBox.min; const size = new THREE.Vector3(); boundingBox.getSize(size); // x component if (this.mesh.position.x \u003c origin.x + this.margin) this.vel.x += this.turnFactor; else if (this.mesh.position.x \u003e origin.x + size.x - this.margin) this.vel.x -= this.turnFactor; // y \u0026 z components are the same After making some debug methods and camera controls, I can now spawn a Boid that moves within a box:\nSpawning multiple Boids makes the animation already has some ~pizzaz~:\nFinally, I implemented the other rules of Boids using the same component approach as the 2D implementation. This is bad because computing vector components this way uses the CPU with each calculation being one at a time. I think A better implementation would take advantage of ThreeJS vector operations. The code would be cleaner as vector operations would be one line and done as ThreeJS intended. However, for even faster computations I may need to implement JavaScript workers or run vector computations on the GPU.\nRegardless, here are some working swarms with different meshes and other small tweaks:\n22-02-25 Optimization Here is the code at the end of this stage\nAs I have stated before, there are a few ways to optimize the simulation so I can render more Boids with less work from the computer. There are 2 main things I can do:\nOptimize vertex computations - Perform all vertex operations in one loop, instead of three functions Optimize draw calls - Since all the Boids are the same mesh, ThreeJS has a special mesh instance that can draw all of them in one call First I rewrote the Boid methods to use ThreeJS vector operations instead of “manual” component computations. After the three methods were reimplemented, I combined them into one single method, sim(boids), that enacted all three forces in a single loop. This improved performance as the algorithm was running through every Boid three times per Boid before, and now is only running through every Boid once per Boid.\nlet neighbors = 0; let match = new THREE.Vector3(); let center = new THREE.Vector3(); for (let otherBoid of boids) { if (this.distance(otherBoid) \u003e= this.field) continue; neighbors++; // Avoid Others (separation) if (otherBoid !== this \u0026\u0026 this.distance(otherBoid) \u003c this.minSeperation) { let avoid = this.vel.clone().sub(otherBoid.vel); this.vel.addScaledVector(avoid, this.avoidFactor); // apply avoid force } // Match (alignment) match.add(otherBoid.vel); // Center (cohesion) center.add(otherBoid.mesh.position); } // Apply Match Force match.add(this.vel); match.divideScalar(neighbors); this.vel.addScaledVector(match, this.matchFactor); // Apply Center Force center.divideScalar(neighbors); center.sub(this.mesh.position); this.vel.addScaledVector(center, this.centeringFactor); Second, I tried optimizing the mesh drawing, into a single GPU draw call. Since all the meshes are the same, I wanted to use THREE.InstancedMesh in ThreeJS. I got multiple meshes to render successfully, but I could not figure out a position transformation on a single mesh. After a lot of struggling I gave up, as the draw calls do not seem to be much of a bottle neck, and it was not worth the pain to try and figure it out. I will probably revisit this when I start importing more complicated meshes but for now I am leaving it alone.\nNow the total amount my computer could render before lagging and heating up went from 300 Boids to 800 Boids.\n22-02-25 Ocean Feel and Code Cleanup Here is the Code at the end of this stage\nNow that I can simulate flocking and my computer does not light on fire, I want to apply this simulation in a scenario. So why not simulate fish?\nFirst I added some debugging tools using dat.gui. This way I could adjust the parameters of a flock easily and see the changes real time.\nNow I focused on the scene. I added a yellow plane at the bottom of the bounding box and changed the color of the fog to blue. Then I expanded the bounding box and camera depth to make the scene feel more like an ocean.\nNext I wanted to be able to simulate different kinds of fish, possibly with different attributes and colors. To do this I just made another Boid controller. This way Boids would only be affected by the other Boids in their flock, meaning different types of fish will not try to swim together. One problem with this solution is that flocks will not try to avoid other flocks, the meshes will past straight through each other. However, this is not a big concern for me right now so maybe I’ll come back to it later.\nHere is how the simulation looks now:\nWith all these changes to the scene, the initialization function (Init()) became really dense and hard to read. It was about time to make a World class that would store the various world elements and their initialization.\nThe following objects are contained in the World instance called ocean:\nScene Camera Light Fog Bounding Box Renderer Camera Controls Each of these objects has its own initialization method, to make the main World constructor easier to understand as well.\nIn addition to separating some of the initialization from main.js, I also gave the BoidController class its own file, instead of keeping it at the bottom of boid.js.\n22-03-07 Importing Models The next step in making my simulation look more like the ocean is actually importing the fish models. Luckily, ThreeJS has a module to import 3D models from a variety of 3D formats. The format I will be using is glTF 2.0 (here is why) so I downloaded the and setup the ThreeJS glTF Loader Module.\nAll I needed to do was load the model in, then clone the Model for each Boid instance to store. This should have been a simple step but I had a bit of difficulty because I did not read enough into the documentation. In the ThreeJS loader I was using it loaded things asynchronously, meaning JavaScript would create a task to load the model, but continue to animate and execute code why the model loaded in the background.\nconst loader = new GLTFLoader(); const fishData = await loader.loadAsync(\"./models/logo.glb\"); const fishMesh = fishData.scene.children[0]; return { fishMesh }; This is obviously helpful most cases where you want to reduce loading lag. Usually you do not want your whole program to halt completely while it loads in a bunch of data. However, to initialize and animate a Boid, the model needed to be initialized first. The mesh holds the position data so the position cannot be changed until the mesh exists. To solve this issue I used the await keyword to insure the import finishes before the rest of the initialization code is executed.\nFor the test fish 3D Model I used blender to convert a STL file into a glTF. I used the UCSC letters model from my 3D Print - UCSC Word project. After scaling and adjusting some world values, the result looks like so:\n22-04-22 Code Refactor and GUI Update Here is the code at the end of this stage\nAs the simulation is nearly finished, it was time to figure out the logistics of interfacing Holoplay (the holographic display software) with my simulation. I knew that ThreeJS would work with the software but I had to think about the easiest way to do this. At the same time, I looked over my Javascript modules and I didn’t like my long import map in my index. Although I loved the simplicity of vanilla Javascript, it was about time to put some more infrastructure behind my code.\nI decided to refactor my code and use Typescript with NodeJS. Dealing with all the different types of meshes and geometries and various objects being passed through functions it would definitely help to have a strongly typed language to stop me from making silly mistakes. I decided to use Vite to bundle my Typescript into a static site. I have heard a lot of good things about Vite and I wouldn’t a simple web bundler that did not require much configuration. Not that I was using Node I imported ThreeJS and its extensions through Npm instead of using downloaded releases.\nAfter all the refactoring, I decided to redo the GUI that controlled the Boid Parameters. I did not like how it was so cluttered, and I wanted the separation, alignment, and cohesion to be clearly distinct with one value each. Here is the old GUI:\nFirst I got rid of the avoidFactor attribute and instead made it equal to 2*this.attributes.maxSpeed/100*this.attributes.minSeperation. This way the avoid factor would scale with the speed and separation distance instead of being a manually controlled parameter. This allowed me to get rid of the subfolders in the GUI making the overall interface a lot cleaner.\nNext, I decided to scale my Boid attributes to have more sensible parameters. The decimal representations were not very pretty and it was confusing that the centeringFactor was 100x smaller than everything else. I spent some time making good coefficients to this attributes, so that the scales would all be from 1 to 10, except for the maxSpeedY which was a ratio of the total speed from 0 to 1. With all of this implemented I renamed the attributes to their original terms and the updated GUI looked a lot cleaner and was a lot more satisfying to control:\nFinally, I decided to do some Git cleanup and add this log to the Github. I wanted the repo to contain all the information about the project so I uploaded the images and this README. Then I merged the 3D branch into the main, and created a gh-pages branch to designate for the static site to be displayed.\n22-05-24 Vicky’s Fish Here is the code at the end of this stage\nFinally I have fish! Thanks to Vicky from the DSC, I finally have 3D fish models to represent my boids. Here they are imported into the simulation:\nOne thing I need to address is the material on the fish. Flat shading like this makes them sort of resemble blobs and takes away from the excellent modeling work that was done. Either I need to add texture, or change the material and lighting for the scene.\nReferences boid simulation Boid Github Repository Leap Motion WebGL Demo Leap Motion Tutorial Something to Aspire to? ","wordCount":"2379","inLanguage":"en","image":"http://example.org/22-02-25__ThreeJS-Boids%20Working-StrawMesh.gif","datePublished":"2020-09-15T11:30:03Z","dateModified":"2020-09-15T11:30:03Z","author":{"@type":"Person","name":"Zack Traczyk"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://example.org/posts/22-02-23-visualizer/"},"publisher":{"@type":"Organization","name":"Zack Traczyk","logo":{"@type":"ImageObject","url":"http://example.org/personal-logo.svg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://example.org/ accesskey=h title="Zack Traczyk (Alt + H)"><img src=http://example.org/personal-logo.svg alt aria-label=logo height=25>Zack Traczyk</a></div><ul id=menu><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div><li><a href=http://example.org/archive/ title=Archive><span>Archive</span></a></li><li><a href=http://example.org/tags/ title=Tags><span>Tags</span></a></li><li><a href=http://example.org/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://example.org/>Home</a>&nbsp;»&nbsp;<a href=http://example.org/posts/>Posts</a></div><h1 class=post-title>3D visualization - Boids</h1><div class=post-description>Simulating flocking behavior in the browser.</div><div class=post-meta><span title='2020-09-15 11:30:03 +0000 +0000'>September 15, 2020</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;2379 words&nbsp;·&nbsp;Zack Traczyk</div></header><figure class=entry-cover><img loading=lazy src=http://example.org/22-02-25__ThreeJS-Boids%20Working-StrawMesh.gif alt="Boid flocking prototype"></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#mission>Mission</a><ul><li><a href=#equipment>Equipment</a></li></ul></li><li><a href=#project-log>Project Log</a><ul><li><a href=#22-02-23-software-compatibility--threejs-setup>22-02-23 Software Compatibility & ThreeJS Setup</a></li><li><a href=#22-02-25-debug-setup-and-naive-boid-movement>22-02-25 Debug Setup and Naive Boid Movement</a></li><li><a href=#22-02-25-optimization>22-02-25 Optimization</a></li><li><a href=#22-02-25-ocean-feel-and-code-cleanup>22-02-25 Ocean Feel and Code Cleanup</a></li><li><a href=#22-03-07-importing-models>22-03-07 Importing Models</a></li><li><a href=#22-04-22-code-refactor-and-gui-update>22-04-22 Code Refactor and GUI Update</a></li><li><a href=#22-05-24-vickys-fish>22-05-24 Vicky&rsquo;s Fish</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><h2 id=mission>Mission<a hidden class=anchor aria-hidden=true href=#mission>#</a></h2><p>Using the 3D visualization tools in the DSI I plan to make an interactive visualization. Specifically I plan to replicate flocking behavior using <a href=https://cs.stanford.edu/people/eroberts/courses/soco/projects/2008-09/modeling-natural-systems/boids.html>Boids</a>, an emerging phenomena and example of complexity theory.</p><p>I hope to use the <a href=https://lookingglassfactory.com/>Looking Glass Portrait</a>, and the Looking Glass 4K to display my simulation in holographic 3D space. Additionally, I plan to use <a href=https://www.ultraleap.com/>Ultraleap</a> to interact with the by tracking a hand in open air.</p><p><strong><em><a href=https://xxzbuckxx.github.io/Boid-Simulation/>Here is my non-holographic demo.</a></em></strong></p><h3 id=equipment>Equipment<a hidden class=anchor aria-hidden=true href=#equipment>#</a></h3><p><a href=https://lookingglassfactory.com/product/4k>Looking Glass</a></p><hr><h2 id=project-log>Project Log<a hidden class=anchor aria-hidden=true href=#project-log>#</a></h2><p><em>I documented my progress on this project below. Although this is not meant to be a guide, it can be used as one given some experience in JavaScript and the code provided at the beginning of each update.</em></p><hr><h3 id=22-02-23-software-compatibility--threejs-setup>22-02-23 Software Compatibility & ThreeJS Setup<a hidden class=anchor aria-hidden=true href=#22-02-23-software-compatibility--threejs-setup>#</a></h3><p><em><a href=https://github.com/xxzbuckxx/Boid-Simulation/tree/f31846cb2795a78cbaee435c9951497d7655b99a>Here is the code at the end of this stage</a></em></p><p>First Thing I looked into is the software that allows the looking glass/portrait to visualize things real time. Luckily, HoloPlay (the software that the portrait uses) has a plugin for <a href=/ThreeJS.html>ThreeJS</a>, a javascript framework I have a bit of experience in.</p><p><strong><a href=https://medium.com/@alxdncn/getting-started-with-the-holoplayer-three-js-library-86bdbeca351>HoloPlayer ThreeJS Plugin Tutorial</a></strong></p><p>Fortunately, I had already made a 2D vision of a Boid simulation using <a href=/JavaScript.html>JavaScript</a> inspired by <a href=https://team.inria.fr/imagine/files/2014/10/flocks-hers-and-schools.pdf>Flocks, Herds, and Schools: A Distributed Behavioral Model</a>. It would take some work as I needed to change rendering engines for HTML5&rsquo;s Canvas to <a href=/ThreeJS.html>ThreeJS</a>, but the logic of the simulation was already figured out which would greatly reduce the difficulty in making the simulation.</p><p><img loading=lazy src=/22-02-23-Boid-Simulation.gif alt=22-02-23-Boid-Simulation.gif></p><p>After restructuring the project and adding a <a href=/JavaScript-module-import-maps.html>import-map</a> to use <a href=/JavaScript.html>JavaScript</a> Modules, I made a simple rotating cube animation.</p><p><img loading=lazy src=/22-02-23-ThreeJS-Simple-Rotating-Cube.gif alt="22-02-23 ThreeJS Simple Rotating Cube.gif"></p><hr><h3 id=22-02-25-debug-setup-and-naive-boid-movement>22-02-25 Debug Setup and Naive Boid Movement<a hidden class=anchor aria-hidden=true href=#22-02-25-debug-setup-and-naive-boid-movement>#</a></h3><p><em><a href=https://github.com/xxzbuckxx/Boid-Simulation/tree/e665aad17aae5b6bdae8e2e6f8cf98ec09344b56>Here is the code at the end of this stage</a></em></p><p>Now that the camera and renderer were setup, I began working on animating a single Boid. I used my constructed box as a bounding box to contain the Boids (eventually this bounding box will be the <strong>Looking Glass</strong>). I used my previous 2D Boid Code as a template for the methods and operations I needed, and I kept the same <code>Boid</code>/<code>BoidController</code> structure with my <code>BoidController</code> class needing minor adjustments.</p><h4 id=initializing-a-boid>Initializing a Boid<a hidden class=anchor aria-hidden=true href=#initializing-a-boid>#</a></h4><p>The first thing I did was create a Boid mesh. The geometry of a Boid can be anything; in more practical examples the mesh would be a bird, or a fish. However to simplify debugging I made the mesh a Tetrahedron with the built-in normal material:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>geometry</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>THREE</span>.<span style=color:#a6e22e>ConeGeometry</span>(<span style=color:#ae81ff>0.05</span>, <span style=color:#ae81ff>0.2</span>, <span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>material</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>THREE</span>.<span style=color:#a6e22e>MeshNormalMaterial</span>();
</span></span></code></pre></div><p>Along with the shape, the main Differences in Boid proprieties were representing the position and velocity as a <code>THREE.vector3</code> instead of as individual vector components.</p><p>Since I was now using <a href=/vectors.html>vectors</a>, most of my code could be easily simplified as <a href=/ThreeJS.html>ThreeJS</a> has all of the needed vector operations built into their <code>THREE.Vector3</code> class. This left the refactored code looking much cleaner but also took some time and research into using <a href=/ThreeJS.html>ThreeJS</a> properly.</p><p>Here is how the Boid is initialized now:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>z</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Create Mesh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mesh</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>THREE</span>.<span style=color:#a6e22e>Mesh</span>(<span style=color:#a6e22e>geometry</span>, <span style=color:#a6e22e>material</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mesh</span>.<span style=color:#a6e22e>position</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>z</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Randomize velocity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vel</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>THREE</span>.<span style=color:#a6e22e>Vector3</span>().<span style=color:#a6e22e>randomDirection</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>maxSpeed</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.02</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=moving-a-boid>Moving a Boid<a hidden class=anchor aria-hidden=true href=#moving-a-boid>#</a></h4><p>Now that Boids can be created, I need them to move and do things. First I made a simple function to randomly place the Boid somewhere in the bounding box. Next I focused on the basic operations in the update loop: moving a Boid according to its velocity, and pointing a Boid in the direction of its velocity.</p><p>These operations only required basic vector operations already implemented in <a href=/ThreeJS.html>ThreeJS</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// Update positions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mesh</span>.<span style=color:#a6e22e>position</span>.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vel</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Update direction
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>axis</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>THREE</span>.<span style=color:#a6e22e>Vector3</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mesh</span>.<span style=color:#a6e22e>quaternion</span>.<span style=color:#a6e22e>setFromUnitVectors</span>(<span style=color:#a6e22e>axis</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vel</span>.<span style=color:#a6e22e>clone</span>().<span style=color:#a6e22e>normalize</span>());
</span></span></code></pre></div><p>Now that a Boid can move, it needs to stay below a maximum speed, and stay within a bounding box. To handle speed I again used simple <a href=/ThreeJS.html>ThreeJS</a> methods to clamp the speed of a Boid. Then to keep inside the bounding Box, I implemented a function <code>pushOnScreen(boundary)</code> that checks if the position of a Boid exceeds the box boundary subtracted by a margin. I adjust each component of the velocity vector by a turning factor to steer away from the wall and back towards the center.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>boundingBox</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>THREE</span>.<span style=color:#a6e22e>Box3</span>().<span style=color:#a6e22e>setFromObject</span>(<span style=color:#a6e22e>boundary</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>origin</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>boundingBox</span>.<span style=color:#a6e22e>min</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>THREE</span>.<span style=color:#a6e22e>Vector3</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>boundingBox</span>.<span style=color:#a6e22e>getSize</span>(<span style=color:#a6e22e>size</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// x component
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mesh</span>.<span style=color:#a6e22e>position</span>.<span style=color:#a6e22e>x</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>origin</span>.<span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>margin</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vel</span>.<span style=color:#a6e22e>x</span> <span style=color:#f92672>+=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>turnFactor</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mesh</span>.<span style=color:#a6e22e>position</span>.<span style=color:#a6e22e>x</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>origin</span>.<span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>size</span>.<span style=color:#a6e22e>x</span> <span style=color:#f92672>-</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>margin</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vel</span>.<span style=color:#a6e22e>x</span> <span style=color:#f92672>-=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>turnFactor</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// y &amp; z components are the same
</span></span></span></code></pre></div><p>After making some debug methods and camera controls, I can now spawn a Boid that moves within a box:</p><p><img loading=lazy src=/22-02-25-ThreeJS-Single-Boid-Debug.gif alt="22-02-25 ThreeJS Single Boid Debug.gif"></p><p>Spawning multiple Boids makes the animation already has some <em>~pizzaz~</em>:</p><p><img loading=lazy src=/22-02-25-ThreeJS-100-Naive-Boids.gif alt="22-02-25 ThreeJS 100 Naive Boids.gif"></p><p>Finally, I implemented the other rules of Boids using the same component approach as the 2D implementation. This is bad because computing vector components this way uses the CPU with each calculation being one at a time. I think A better implementation would take advantage of <a href=/ThreeJS.html>ThreeJS</a> <a href=/vectors.html>vector</a> operations. The code would be cleaner as vector operations would be one line and done as ThreeJS intended. However, for even faster computations I may need to implement <a href=https://medium.com/techtrument/multithreading-javascript-46156179cf9a>JavaScript workers</a> or run vector computations on the GPU.</p><p>Regardless, here are some working swarms with different meshes and other small tweaks:</p><p><img loading=lazy src=/22-02-25-ThreeJS-Boids-Working.gif alt="22-02-25 ThreeJS Boids Working.gif">
<img loading=lazy src=/22-02-25-ThreeJS-Boids-Working-StrawMesh.gif alt="22-02-25 ThreeJS Boids Working StrawMesh.gif">
<img loading=lazy src=/22-02-27-ThreeJS-Boids-Working-Fog.gif alt="22-02-27 ThreeJS Boids Working Fog.gif"></p><hr><h3 id=22-02-25-optimization>22-02-25 Optimization<a hidden class=anchor aria-hidden=true href=#22-02-25-optimization>#</a></h3><p><em><a href=https://github.com/xxzbuckxx/Boid-Simulation/tree/09a6cd0c333b5c2a871a5e14c89abc848917705e>Here is the code at the end of this stage</a></em></p><p>As I have stated before, there are a few ways to optimize the simulation so I can render more Boids with less work from the computer. There are 2 main things I can do:</p><ol><li>Optimize vertex computations - Perform all vertex operations in one loop, instead of three functions</li><li>Optimize draw calls - Since all the Boids are the same mesh, <a href=/ThreeJS.html>ThreeJS</a> has a special mesh instance that can draw all of them in one call</li></ol><p>First I rewrote the Boid methods to use <a href=/ThreeJS.html>ThreeJS</a> <a href=/vectors.html>vector</a> operations instead of &ldquo;manual&rdquo; component computations. After the three methods were reimplemented, I combined them into one single method, <code>sim(boids)</code>, that enacted all three forces in a single loop. This improved performance as the algorithm was running through every Boid three times per Boid before, and now is only running through every Boid once per Boid.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>neighbors</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>match</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>THREE</span>.<span style=color:#a6e22e>Vector3</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>center</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>THREE</span>.<span style=color:#a6e22e>Vector3</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>otherBoid</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>boids</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>distance</span>(<span style=color:#a6e22e>otherBoid</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>field</span>) <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>neighbors</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Avoid Others (separation)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>otherBoid</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>this</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>distance</span>(<span style=color:#a6e22e>otherBoid</span>) <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>minSeperation</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>avoid</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vel</span>.<span style=color:#a6e22e>clone</span>().<span style=color:#a6e22e>sub</span>(<span style=color:#a6e22e>otherBoid</span>.<span style=color:#a6e22e>vel</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vel</span>.<span style=color:#a6e22e>addScaledVector</span>(<span style=color:#a6e22e>avoid</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>avoidFactor</span>); <span style=color:#75715e>// apply avoid force
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Match (alignment)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>match</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>otherBoid</span>.<span style=color:#a6e22e>vel</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Center (cohesion)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>center</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>otherBoid</span>.<span style=color:#a6e22e>mesh</span>.<span style=color:#a6e22e>position</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Apply Match Force
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>match</span>.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vel</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>match</span>.<span style=color:#a6e22e>divideScalar</span>(<span style=color:#a6e22e>neighbors</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vel</span>.<span style=color:#a6e22e>addScaledVector</span>(<span style=color:#a6e22e>match</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>matchFactor</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Apply Center Force
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>center</span>.<span style=color:#a6e22e>divideScalar</span>(<span style=color:#a6e22e>neighbors</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>center</span>.<span style=color:#a6e22e>sub</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mesh</span>.<span style=color:#a6e22e>position</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>vel</span>.<span style=color:#a6e22e>addScaledVector</span>(<span style=color:#a6e22e>center</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>centeringFactor</span>);
</span></span></code></pre></div><p>Second, I tried optimizing the mesh drawing, into a single GPU draw call. Since all the meshes are the same, I wanted to use <code>THREE.InstancedMesh</code> in <a href=/ThreeJS.html>ThreeJS</a>. I got multiple meshes to render successfully, but I could not figure out a position transformation on a single mesh. After a lot of struggling I gave up, as the draw calls do not seem to be much of a bottle neck, and it was not worth the pain to try and figure it out. I will probably revisit this when I start importing more complicated meshes but for now I am leaving it alone.</p><p>Now the total amount my computer could render before lagging and heating up went from 300 Boids to 800 Boids.</p><hr><h3 id=22-02-25-ocean-feel-and-code-cleanup>22-02-25 Ocean Feel and Code Cleanup<a hidden class=anchor aria-hidden=true href=#22-02-25-ocean-feel-and-code-cleanup>#</a></h3><p><em><a href=https://github.com/xxzbuckxx/Boid-Simulation/tree/a4d11387252f5c577eb8c3c6a74b34e745bcf890>Here is the Code at the end of this stage</a></em></p><p>Now that I can simulate flocking and my computer does not light on fire, I want to apply this simulation in a scenario. So why not simulate fish?</p><p>First I added some debugging tools using <a href=https://github.com/dataarts/dat.gui>dat.gui</a>. This way I could adjust the parameters of a flock easily and see the changes real time.</p><p>Now I focused on the scene. I added a yellow plane at the bottom of the bounding box and changed the color of the fog to blue. Then I expanded the bounding box and camera depth to make the scene feel more like an ocean.</p><p>Next I wanted to be able to simulate different kinds of fish, possibly with different attributes and colors. To do this I just made another Boid controller. This way Boids would only be affected by the other Boids in their flock, meaning different types of fish will not try to swim together. One problem with this solution is that flocks will not try to avoid other flocks, the meshes will past straight through each other. However, this is not a big concern for me right now so maybe I&rsquo;ll come back to it later.</p><p>Here is how the simulation looks now:</p><p><img loading=lazy src=/22-03-02-ThreeJS-Boids-2-Flock-Basic-Ocean.gif alt="22-03-02 ThreeJS Boids 2 Flock Basic Ocean.gif"></p><p>With all these changes to the scene, the initialization function (<code>Init()</code>) became really dense and hard to read. It was about time to make a <code>World</code> class that would store the various world elements and their initialization.</p><p>The following objects are contained in the <code>World</code> instance called <code>ocean</code>:</p><ol><li>Scene</li><li>Camera</li><li>Light</li><li>Fog</li><li>Bounding Box</li><li>Renderer</li><li>Camera Controls</li></ol><p>Each of these objects has its own initialization method, to make the main <code>World</code> constructor easier to understand as well.</p><p>In addition to separating some of the initialization from <code>main.js</code>, I also gave the <code>BoidController</code> class its own file, instead of keeping it at the bottom of <code>boid.js</code>.</p><hr><h3 id=22-03-07-importing-models>22-03-07 Importing Models<a hidden class=anchor aria-hidden=true href=#22-03-07-importing-models>#</a></h3><p>The next step in making my simulation look more like the ocean is actually importing the fish models. Luckily, <a href=/ThreeJS.html>ThreeJS</a> has a module to import 3D models from a variety of 3D formats. The format I will be using is glTF 2.0 (<a href=https://godotengine.org/article/we-should-all-use-gltf-20-export-3d-assets-game-engines>here is why</a>) so I downloaded the and setup the <a href=/ThreeJS.html>ThreeJS</a> <a href=https://threejs.org/manual/#en/load-gltf>glTF Loader Module</a>.</p><p>All I needed to do was load the model in, then clone the Model for each Boid instance to store. This should have been a simple step but I had a bit of difficulty because I did not read enough into the documentation. In the <a href=/ThreeJS.html>ThreeJS</a> loader I was using it loaded things asynchronously, meaning <a href=/JavaScript.html>JavaScript</a> would create a task to load the model, but continue to animate and execute code why the model loaded in the background.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>loader</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GLTFLoader</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fishData</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>loader</span>.<span style=color:#a6e22e>loadAsync</span>(<span style=color:#e6db74>&#34;./models/logo.glb&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fishMesh</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fishData</span>.<span style=color:#a6e22e>scene</span>.<span style=color:#a6e22e>children</span>[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>fishMesh</span> };
</span></span></code></pre></div><p>This is obviously helpful most cases where you want to reduce loading lag. Usually you do not want your whole program to halt completely while it loads in a bunch of data. However, to initialize and animate a Boid, the model needed to be initialized first. The mesh holds the position data so the position cannot be changed until the mesh exists. To solve this issue I used the <code>await</code> keyword to insure the import finishes before the rest of the initialization code is executed.</p><p>For the test fish 3D Model I used blender to convert a STL file into a glTF. I used the UCSC letters model from my <a href=/3D-Print---UCSC-Word.html>3D Print - UCSC Word</a> project. After scaling and adjusting some world values, the result looks like so:</p><p><img loading=lazy src=/22-03-07-ThreeJS-Boids-2-Flock-UCSC-Model.gif alt="22-03-07 ThreeJS Boids 2 Flock UCSC Model.gif"></p><hr><h3 id=22-04-22-code-refactor-and-gui-update>22-04-22 Code Refactor and GUI Update<a hidden class=anchor aria-hidden=true href=#22-04-22-code-refactor-and-gui-update>#</a></h3><p><a href=https://github.com/xxzbuckxx/Boid-Simulation/tree/060319d00bc5566329b232d01fbae34d7495d0f6>Here is the code at the end of this stage</a></p><p>As the simulation is nearly finished, it was time to figure out the logistics of interfacing Holoplay (the holographic display software) with my simulation. I knew that <a href=/ThreeJS.html>ThreeJS</a> would work with the software but I had to think about the easiest way to do this. At the same time, I looked over my <a href=/Javascript.html>Javascript</a> modules and I didn&rsquo;t like my long import map in my index. Although I loved the simplicity of vanilla Javascript, it was about time to put some more infrastructure behind my code.</p><p>I decided to refactor my code and use <a href=/Typescript.html>Typescript</a> with <a href=/NodeJS.html>NodeJS</a>. Dealing with all the different types of meshes and geometries and various objects being passed through functions it would definitely help to have a strongly typed language to stop me from making silly mistakes. I decided to use <a href=/Vite.html>Vite</a> to bundle my <a href=/Typescript.html>Typescript</a> into a static site. I have heard a lot of good things about <a href=/Vite.html>Vite</a> and I wouldn&rsquo;t a simple web bundler that did not require much configuration. Not that I was using Node I imported <a href=/ThreeJS.html>ThreeJS</a> and its extensions through <a href=/Npm.html>Npm</a> instead of using downloaded releases.</p><p>After all the refactoring, I decided to redo the GUI that controlled the Boid Parameters. I did not like how it was so cluttered, and I wanted the separation, alignment, and cohesion to be clearly distinct with one value each. Here is the old GUI:</p><p><img loading=lazy src=/22-04-22-Old-UI.png alt="22-04-22 Old UI.png"></p><p>First I got rid of the avoidFactor attribute and instead made it equal to <code>2*this.attributes.maxSpeed/100*this.attributes.minSeperation</code>. This way the avoid factor would scale with the speed and separation distance instead of being a manually controlled parameter. This allowed me to get rid of the subfolders in the GUI making the overall interface a lot cleaner.</p><p>Next, I decided to scale my Boid attributes to have more sensible parameters. The decimal representations were not very pretty and it was confusing that the centeringFactor was 100x smaller than everything else. I spent some time making good coefficients to this attributes, so that the scales would all be from 1 to 10, except for the maxSpeedY which was a ratio of the total speed from 0 to 1. With all of this implemented I renamed the attributes to their original terms and the updated GUI looked a lot cleaner and was a lot more satisfying to control:</p><p><img loading=lazy src=/22-04-22-New-UI.png alt="22-04-22 New UI.png"></p><p>Finally, I decided to do some Git cleanup and add this log to the Github. I wanted the repo to contain all the information about the project so I uploaded the images and this README. Then I merged the 3D branch into the <code>main</code>, and created a <code>gh-pages</code> branch to designate for the static site to be displayed.</p><hr><h3 id=22-05-24-vickys-fish>22-05-24 Vicky&rsquo;s Fish<a hidden class=anchor aria-hidden=true href=#22-05-24-vickys-fish>#</a></h3><p><a href>Here is the code at the end of this stage</a></p><p>Finally I have fish! Thanks to Vicky from the DSC, I finally have 3D fish models to represent my boids. Here they are imported into the simulation:</p><p><img loading=lazy src=/22-05-24-Vicky-Fish-First-Import.gif alt="22-05-24 Vicky Fish First Import.gif"></p><p>One thing I need to address is the material on the fish. Flat shading like this makes them sort of resemble blobs and takes away from the excellent modeling work that was done. Either I need to add texture, or change the material and lighting for the scene.</p><hr><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ol><li><a href=https://cs.stanford.edu/people/eroberts/courses/soco/projects/2008-09/modeling-natural-systems/boids.html>boid simulation</a></li><li><a href=https://github.com/xxzbuckxx/Boid-Simulation>Boid Github Repository</a></li><li><a href=https://developer-archive.leapmotion.com/gallery/touch-with-webgl-leap-motion>Leap Motion WebGL Demo</a></li><li><a href=https://github.com/motdotla/writings/blob/master/articles/posts/beginners-guide-to-leap-motion-with-nodejs.md>Leap Motion Tutorial</a></li><li><a href=https://web.archive.org/web/20210531135555/http://www.fishgl.com/>Something to Aspire to?</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=http://example.org/tags/javascript/>Javascript</a></li><li><a href=http://example.org/tags/dsi/>DSI</a></li><li><a href=http://example.org/tags/3d-modeling/>3d modeling</a></li><li><a href=http://example.org/tags/complexity-theory/>complexity theory</a></li></ul><nav class=paginav><a class=prev href=http://example.org/posts/22-02-22-sadc-meeting---1/><span class=title>« Prev</span><br><span>3D visualization - Boids</span></a>
<a class=next href=http://example.org/posts/22-03-01-sadc-meeting---2/><span class=title>Next »</span><br><span>3D visualization - Boids</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share 3D visualization - Boids on twitter" href="https://twitter.com/intent/tweet/?text=3D%20visualization%20-%20Boids&url=http%3a%2f%2fexample.org%2fposts%2f22-02-23-visualizer%2f&hashtags=Javascript%2cDSI%2c3dmodeling%2ccomplexitytheory"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 3D visualization - Boids on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fexample.org%2fposts%2f22-02-23-visualizer%2f&title=3D%20visualization%20-%20Boids&summary=3D%20visualization%20-%20Boids&source=http%3a%2f%2fexample.org%2fposts%2f22-02-23-visualizer%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 3D visualization - Boids on reddit" href="https://reddit.com/submit?url=http%3a%2f%2fexample.org%2fposts%2f22-02-23-visualizer%2f&title=3D%20visualization%20-%20Boids"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 3D visualization - Boids on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2fexample.org%2fposts%2f22-02-23-visualizer%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 3D visualization - Boids on whatsapp" href="https://api.whatsapp.com/send?text=3D%20visualization%20-%20Boids%20-%20http%3a%2f%2fexample.org%2fposts%2f22-02-23-visualizer%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 3D visualization - Boids on telegram" href="https://telegram.me/share/url?text=3D%20visualization%20-%20Boids&url=http%3a%2f%2fexample.org%2fposts%2f22-02-23-visualizer%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>